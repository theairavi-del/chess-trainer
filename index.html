<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grandmaster Chess Trainer</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.1/chess.min.js"></script>
    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --surface-hover: #2d2d2d;
            --accent: #00c853;
            --accent-hover: #00e676;
            --text: #ffffff;
            --text-muted: #b0b0b0;
            --border: #333333;
            --panel-width: 380px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 15px 30px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-tab:hover {
            color: var(--text);
            background: var(--surface-hover);
        }

        .nav-tab.active {
            color: var(--accent);
            border-color: var(--accent);
            background: rgba(0, 200, 83, 0.1);
        }

        main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr var(--panel-width);
            gap: 0;
            overflow: hidden;
        }

        .board-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #181818;
            position: relative;
        }

        #board {
            width: 100%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .sidebar {
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        /* Eval Bar */
        .eval-container {
            height: 30px;
            background: #fff;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            position: relative;
            margin-bottom: 20px;
        }

        .eval-black {
            background: #333;
            width: 50%;
            transition: width 0.5s ease;
        }

        .eval-value {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            mix-blend-mode: difference;
            color: white;
            z-index: 2;
        }

        /* Feedback Styles */
        .feedback-card {
            background: var(--bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--border);
        }

        .feedback-excellent { border-color: #00c853; }
        .feedback-good { border-color: #b2ff59; }
        .feedback-ok { border-color: #ffff00; }
        .feedback-inaccurate { border-color: #ffc107; }
        .feedback-mistake { border-color: #ff9100; }
        .feedback-blunder { border-color: #ff1744; }

        .quality-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .quality-excellent { background: #00c853; color: #000; }
        .quality-good { background: #b2ff59; color: #000; }
        .quality-ok { background: #ffff00; color: #000; }
        .quality-inaccurate { background: #ffc107; color: #000; }
        .quality-mistake { background: #ff9100; color: #000; }
        .quality-blunder { background: #ff1744; color: #fff; }

        .explanation {
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .suggestions {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .suggestion-item {
            cursor: pointer;
            color: var(--accent);
            text-decoration: underline;
        }

        /* Voice Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        input[type="text"], input[type="password"], select {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn:hover { background: var(--accent-hover); }

        .btn-secondary {
            background: var(--surface-hover);
            color: var(--text);
            margin-top: 10px;
        }

        /* Opening Trainer */
        .opening-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .opening-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 6px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .opening-btn:hover {
            border-color: var(--accent);
            background: var(--surface-hover);
        }

        .opening-name {
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        .opening-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* UI Overlays */
        #training-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
            z-index: 100;
            border: 1px solid var(--accent);
        }

        .hidden { display: none !important; }

        /* Stockfish Eval Colors */
        .white-1e1d7 { background-color: #b58863 !important; }
        .black-3c85d { background-color: #f0d9b5 !important; }

        .move-history {
            flex: 1;
            padding: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--text-muted);
            overflow-y: auto;
        }

        .current-move-explanation {
            font-style: italic;
            color: var(--accent);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">♟️ Grandmaster AI Trainer</div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-mode="play">Play & Analyze</button>
            <button class="nav-tab" data-mode="train">Opening Trainer</button>
            <button class="nav-tab" data-mode="settings">Voice Settings</button>
        </div>
    </header>

    <main>
        <section class="board-section">
            <div id="training-overlay">
                <h2 id="opening-title">Opening Name</h2>
                <p id="opening-info">Description goes here...</p>
            </div>
            <div id="board"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="undo-btn">Undo</button>
                <button class="btn btn-secondary" id="flip-btn">Flip Board</button>
                <button class="btn" id="new-game-btn">New Game</button>
            </div>
        </section>

        <section class="sidebar">
            <!-- PLAY MODE SIDEBAR -->
            <div id="play-sidebar">
                <div class="panel-section">
                    <div class="panel-title">Real-time Analysis</div>
                    <div class="eval-container">
                        <div class="eval-value">0.0</div>
                        <div class="eval-black" style="width: 50%;"></div>
                    </div>
                    <div id="move-feedback">
                        <div class="feedback-card">
                            <div class="quality-badge quality-ok">Neutral</div>
                            <div class="explanation">Make a move to see analysis. The AI will evaluate your play instantly.</div>
                        </div>
                    </div>
                </div>
                <div class="panel-section" style="flex: 1; display: flex; flex-direction: column;">
                    <div class="panel-title">Move History</div>
                    <div class="move-history" id="pgn-display"></div>
                </div>
            </div>

            <!-- TRAIN MODE SIDEBAR -->
            <div id="train-sidebar" class="hidden">
                <div class="panel-section">
                    <div class="panel-title">Select Opening</div>
                    <div class="opening-list">
                        <button class="opening-btn" data-opening="italian">
                            <span class="opening-name">Italian Game</span>
                            <span class="opening-desc">Classic development focusing on the center and f7.</span>
                        </button>
                        <button class="opening-btn" data-opening="sicilian">
                            <span class="opening-name">Sicilian Defense</span>
                            <span class="opening-desc">Sharp, asymmetrical counter-play for Black.</span>
                        </button>
                        <button class="opening-btn" data-opening="ruylopez">
                            <span class="opening-name">Ruy Lopez</span>
                            <span class="opening-desc">The "Spanish Torture" - deep strategic pressure.</span>
                        </button>
                        <button class="opening-btn" data-opening="queensgambit">
                            <span class="opening-name">Queen's Gambit</span>
                            <span class="opening-desc">Offering a pawn for central domination.</span>
                        </button>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="panel-title">Training Status</div>
                    <div id="train-status" class="explanation">Select an opening to begin training.</div>
                </div>
            </div>

            <!-- SETTINGS SIDEBAR -->
            <div id="settings-sidebar" class="hidden">
                <div class="panel-section">
                    <div class="panel-title">ElevenLabs Integration</div>
                    <div class="settings-grid">
                        <div class="input-group">
                            <label>API Key</label>
                            <input type="password" id="eleven-api-key" placeholder="Enter your ElevenLabs API key">
                        </div>
                        <div class="input-group">
                            <label>Voice</label>
                            <select id="eleven-voice-id">
                                <option value="21m00Tcm4llvDq8ikWAM">Rachel (Default)</option>
                                <option value="AZnzlk1XhxPqc80f0nMt">Nicole</option>
                                <option value="EXAVITQu4vr4xnNLMQbx">Bella</option>
                                <option value="MF3mGyEYCl7XYW7LecjN">Josh</option>
                            </select>
                        </div>
                        <button class="btn" id="save-settings">Save Settings</button>
                        <p class="explanation" style="font-size: 0.8rem; color: var(--text-muted);">
                            If API key is missing or fails, the app will automatically fallback to your browser's default text-to-speech.
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // CONFIG & STATE
        let game = new Chess();
        let board = null;
        let currentMode = 'play';
        let trainingData = null;
        let trainingStep = 0;
        let isTrainingInteractive = false;
        
        const voiceConfig = {
            apiKey: localStorage.getItem('eleven_api_key') || '',
            voiceId: localStorage.getItem('eleven_voice_id') || '21m00Tcm4llvDq8ikWAM',
            useEleven: !!localStorage.getItem('eleven_api_key')
        };

        const openings = {
            italian: {
                name: 'Italian Game',
                desc: 'The Italian Game starts with 1.e4 e5 2.Nf3 Nc6 3.Bc4. It aims to control the center and attack the weak f7 square.',
                moves: ['e4', 'e5', 'Nf3', 'Nc6', 'Bc4'],
                explanations: {
                    'e4': "Controlling the center with the king's pawn",
                    'e5': "Black responds by challenging the center",
                    'Nf3': "Developing the knight toward the center and attacking e5",
                    'Nc6': "Developing and defending the e5 pawn",
                    'Bc4': "The Italian signature: Aiming at the weak f7 square"
                }
            },
            sicilian: {
                name: 'Sicilian Defense',
                desc: 'The Sicilian is the most popular response to 1.e4. It creates an asymmetrical position where Black fights for the d4 square.',
                moves: ['e4', 'c5', 'Nf3', 'd6'],
                explanations: {
                    'e4': "White claims the center with the king's pawn",
                    'c5': "Fighting for d4 control, creating asymmetry",
                    'Nf3': "Developing and preparing the d4 push",
                    'd6': "Preparing knight development, supporting e5 and controlling c5"
                }
            },
            ruylopez: {
                name: 'Ruy Lopez',
                desc: 'One of the oldest and most studied openings. White pins the knight on c6 to put indirect pressure on the e5 pawn.',
                moves: ['e4', 'e5', 'Nf3', 'Nc6', 'Bb5'],
                explanations: {
                    'e4': "Standard central opening",
                    'e5': "Classical response",
                    'Nf3': "Attacking e5 and developing",
                    'Nc6': "Defending e5",
                    'Bb5': "The Ruy Lopez - pinning the knight to pressure e5"
                }
            },
            queensgambit: {
                name: "Queen's Gambit",
                desc: 'White offers a flank pawn (c4) to gain more control over the center with the d-pawn.',
                moves: ['d4', 'd5', 'c4'],
                explanations: {
                    'd4': "Starting with the queen's pawn for a solid center",
                    'd5': "Black matches White's central control",
                    'c4': "Offering the c-pawn to control the center"
                }
            }
        };

        // EVALUATION ENGINE
        function evaluatePosition(game) {
            let score = 0;
            
            // Material
            const pieces = { p: 1, n: 3, b: 3.25, r: 5, q: 9, k: 0 };
            const board = game.board();
            
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    const piece = board[i][j];
                    if (piece) {
                        const val = pieces[piece.type];
                        score += piece.color === 'w' ? val : -val;
                        
                        // Simple development bonus
                        if (piece.type === 'n' || piece.type === 'b') {
                            if (piece.color === 'w' && i < 7) score += 0.1;
                            if (piece.color === 'b' && i > 0) score -= 0.1;
                        }
                    }
                }
            }
            
            // Center control
            const centerSquares = [['d4', 'd5', 'e4', 'e5'], ['d3', 'd6', 'e3', 'e6']];
            centerSquares[0].forEach(sq => {
                const piece = game.get(sq);
                if (piece) score += piece.color === 'w' ? 0.3 : -0.3;
            });
            
            // King Safety (very basic)
            const whiteKing = findPiece(game, 'k', 'w');
            const blackKing = findPiece(game, 'k', 'b');
            
            if (whiteKing && (whiteKing === 'g1' || whiteKing === 'c1')) score += 0.5;
            if (blackKing && (blackKing === 'g8' || blackKing === 'c8')) score -= 0.5;
            
            return score;
        }

        function findPiece(game, type, color) {
            const board = game.board();
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const p = board[r][c];
                    if (p && p.type === type && p.color === color) {
                        return String.fromCharCode(97 + c) + (8 - r);
                    }
                }
            }
            return null;
        }

        // VOICE ENGINE
        async function speak(text) {
            console.log("Speaking:", text);
            if (voiceConfig.apiKey && voiceConfig.apiKey.length > 10) {
                try {
                    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceConfig.voiceId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'xi-api-key': voiceConfig.apiKey
                        },
                        body: JSON.stringify({
                            text: text,
                            model_id: "eleven_monolingual_v1",
                            voice_settings: { stability: 0.5, similarity_boost: 0.5 }
                        })
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const audio = new Audio(url);
                        audio.play();
                        return;
                    }
                } catch (e) {
                    console.error("ElevenLabs failed, falling back to browser TTS", e);
                }
            }
            
            // Fallback to browser TTS
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            utterance.voice = voices.find(v => v.name.includes('Rachel')) || voices[0];
            window.speechSynthesis.speak(utterance);
        }

        // UI HELPERS
        function updateEvalBar(score) {
            // Normalize score to percentage (-5 to 5 range)
            let percent = 50 - (score * 10);
            percent = Math.max(5, Math.min(95, percent));
            $('.eval-black').css('width', percent + '%');
            $('.eval-value').text((score > 0 ? '+' : '') + score.toFixed(1));
        }

        function getFeedback(oldEval, newEval, move) {
            const diff = game.turn() === 'b' ? (newEval - oldEval) : (oldEval - newEval); // diff from mover's perspective
            
            let quality = 'ok';
            let message = 'Good move. You\'re developing your pieces actively.';
            let badgeClass = 'quality-ok';
            let cardClass = 'feedback-ok';

            if (diff > 0.5) {
                quality = 'excellent';
                message = 'Excellent! You found a strong tactical move.';
                badgeClass = 'quality-excellent';
                cardClass = 'feedback-excellent';
            } else if (diff > -0.2) {
                quality = 'good';
                message = 'Good move. Solid play.';
                badgeClass = 'quality-good';
                cardClass = 'feedback-good';
            } else if (diff > -0.8) {
                quality = 'inaccurate';
                message = 'Inaccurate. Consider developing a piece instead.';
                badgeClass = 'quality-inaccurate';
                cardClass = 'feedback-inaccurate';
            } else if (diff > -2.0) {
                quality = 'mistake';
                message = 'Mistake! This hangs a piece or loses positional advantage.';
                badgeClass = 'quality-mistake';
                cardClass = 'feedback-mistake';
            } else {
                quality = 'blunder';
                message = 'Blunder! You lose material. Better was looking for a safer square.';
                badgeClass = 'quality-blunder';
                cardClass = 'feedback-blunder';
            }

            // Check for material loss specifically
            if (move.captured) {
                if (diff < -2) message = `Blunder! You lost material. Better was protecting your pieces.`;
            }

            return `
                <div class="feedback-card ${cardClass}">
                    <div class="quality-badge ${badgeClass}">${quality}</div>
                    <div class="explanation">${message}</div>
                    <div class="suggestions">Move: <strong>${move.san}</strong> • Change: ${(diff > 0 ? '+' : '') + diff.toFixed(2)}</div>
                </div>
            `;
        }

        // GAME LOGIC
        function onDragStart(source, piece, position, orientation) {
            if (game.game_over()) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        async function onDrop(source, target) {
            const prevEval = evaluatePosition(game);
            
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            updateBoard();
            
            if (currentMode === 'play') {
                const newEval = evaluatePosition(game);
                const feedbackHtml = getFeedback(prevEval, newEval, move);
                $('#move-feedback').prepend(feedbackHtml);
                updateEvalBar(newEval);
                
                // Engine Response
                setTimeout(makeRandomMove, 500);
            } else if (currentMode === 'train' && isTrainingInteractive) {
                checkTrainingMove(move);
            }
        }

        function makeRandomMove() {
            const moves = game.moves();
            if (moves.length === 0) return;
            
            const randomIdx = Math.floor(Math.random() * moves.length);
            game.move(moves[randomIdx]);
            updateBoard();
            updateEvalBar(evaluatePosition(game));
        }

        function updateBoard() {
            board.position(game.fen());
            $('#pgn-display').text(game.pgn());
        }

        // TRAINING LOGIC
        async function startOpeningTraining(key) {
            trainingData = openings[key];
            trainingStep = 0;
            isTrainingInteractive = false;
            game.reset();
            updateBoard();
            
            $('#training-overlay').fadeIn().find('#opening-title').text(trainingData.name);
            $('#opening-info').text(trainingData.desc);
            $('#train-status').text("Watching demonstration...");
            
            speak(trainingData.name + ". " + trainingData.desc);

            // Demonstration phase
            for (let i = 0; i < trainingData.moves.length; i++) {
                await new Promise(r => setTimeout(r, 2500));
                const moveSan = trainingData.moves[i];
                const explanation = trainingData.explanations[moveSan] || "";
                
                game.move(moveSan);
                updateBoard();
                
                if (explanation) {
                    $('#opening-info').text(explanation);
                    speak(explanation);
                }
            }

            await new Promise(r => setTimeout(r, 3000));
            
            // Interactive phase
            game.reset();
            updateBoard();
            trainingStep = 0;
            isTrainingInteractive = true;
            $('#training-overlay').fadeOut();
            $('#train-status').html("<strong>Your turn!</strong> Repeat the opening moves.");
            speak("Now it's your turn. Repeat the moves you just saw.");
        }

        function checkTrainingMove(move) {
            const expected = trainingData.moves[trainingStep];
            
            if (move.san === expected) {
                trainingStep++;
                const explanation = trainingData.explanations[move.san] || "Correct!";
                $('#train-status').text(explanation);
                speak(explanation);

                if (trainingStep >= trainingData.moves.length) {
                    $('#train-status').html("<span style='color: var(--accent)'>Excellent! Opening training complete.</span>");
                    speak("Excellent! You have successfully learned the " + trainingData.name);
                    isTrainingInteractive = false;
                } else {
                    // Make opponent move
                    setTimeout(() => {
                        const nextMove = trainingData.moves[trainingStep];
                        game.move(nextMove);
                        updateBoard();
                        trainingStep++;
                        const oppExpl = trainingData.explanations[nextMove] || "";
                        if (oppExpl) speak(oppExpl);
                        
                        if (trainingStep >= trainingData.moves.length) {
                           $('#train-status').html("<span style='color: var(--accent)'>Opening complete!</span>");
                           isTrainingInteractive = false;
                        }
                    }, 1000);
                }
            } else {
                game.undo();
                updateBoard();
                $('#train-status').html("<span style='color: #ff1744'>Wrong move. Try again!</span> Looking for: " + expected);
                speak("That's not the right move for this opening. Try again.");
            }
        }

        // INITIALIZATION
        $(document).ready(() => {
            const config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            board = Chessboard('board', config);

            // Nav Tabs
            $('.nav-tab').on('click', function() {
                const mode = $(this).data('mode');
                $('.nav-tab').removeClass('active');
                $(this).addClass('active');
                
                $('.sidebar > div').addClass('hidden');
                $(`#${mode}-sidebar`).removeClass('hidden');
                currentMode = mode;
                
                if (mode === 'play') {
                    $('#training-overlay').hide();
                    isTrainingInteractive = false;
                }
            });

            // Opening Selectors
            $('.opening-btn').on('click', function() {
                const openingKey = $(this).data('opening');
                startOpeningTraining(openingKey);
            });

            // Settings
            $('#eleven-api-key').val(voiceConfig.apiKey);
            $('#eleven-voice-id').val(voiceConfig.voiceId);

            $('#save-settings').on('click', () => {
                const key = $('#eleven-api-key').val();
                const vId = $('#eleven-voice-id').val();
                localStorage.setItem('eleven_api_key', key);
                localStorage.setItem('eleven_voice_id', vId);
                voiceConfig.apiKey = key;
                voiceConfig.voiceId = vId;
                alert('Settings saved!');
            });

            // Board Controls
            $('#undo-btn').on('click', () => {
                game.undo();
                game.undo(); // Undo engine move too
                updateBoard();
            });

            $('#flip-btn').on('click', () => {
                board.flip();
            });

            $('#new-game-btn').on('click', () => {
                game.reset();
                updateBoard();
                $('#move-feedback').empty();
                updateEvalBar(0);
            });

            $(window).resize(() => board.resize());
        });
    </script>
</body>
</html>
